<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Call Map v1</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: #f5f7f9;
            color: #333;
            overflow: hidden;
        }
        
        #header {
            background: linear-gradient(135deg, #2c3e50 0%, #4a6491 100%);
            color: white;
            padding: 12px 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo-icon {
            background-color: #3498db;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .logo h1 {
            font-size: 22px;
            font-weight: 600;
        }
        
        #container {
            display: flex;
            height: calc(100vh - 64px);
        }
        
        #sidebar {
            width: 320px;
            background: white;
            border-right: 1px solid #e0e6ed;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .sidebar-section {
            padding: 16px;
            border-bottom: 1px solid #e0e6ed;
        }
        
        .sidebar-section h3 {
            font-size: 16px;
            margin-bottom: 12px;
            color: #2c3e50;
            font-weight: 600;
        }
        
        .filters {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .filter-group label {
            font-size: 14px;
            color: #5a6b7e;
        }
        
        .filter-group select, .filter-group input {
            padding: 8px;
            border: 1px solid #d1d9e2;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }
        
        .stats {
            display: flex;
            gap: 12px;
        }
        
        .stat-box {
            flex: 1;
            background: #f8fafc;
            border: 1px solid #e0e6ed;
            border-radius: 6px;
            padding: 12px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
        }
        
        .stat-label {
            font-size: 12px;
            color: #5a6b7e;
            margin-top: 4px;
        }
        
        #calls-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .call-item {
            background: #f8fafc;
            border: 1px solid #e0e6ed;
            border-radius: 6px;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .call-info {
            flex: 1;
        }
        
        .call-number {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .call-time {
            font-size: 12px;
            color: #5a6b7e;
            margin-top: 2px;
        }
        
        .call-location {
            font-size: 14px;
            margin-top: 4px;
            color: #5a6b7e;
        }
        
        .call-queue {
            font-size: 12px;
            margin-top: 4px;
            color: #3498db;
        }
        
        .call-actions button {
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 10px;
            font-size: 12px;
            cursor: pointer;
        }
        
        #map-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        #controls {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 280px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            z-index: 1000;
        }
        
        #controls-header {
            background: #2c3e50;
            color: white;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
        }
        
        #toggle-controls {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 16px;
        }
        
        #controls-content {
            padding: 16px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .control-group h3 {
            font-size: 16px;
            color: #2c3e50;
            margin-bottom: 4px;
        }
        
        .button-group {
            display: flex;
            gap: 8px;
        }
        
        .button-group button {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .button-group button:first-child {
            background: #e74c3c;
            color: white;
        }
        
        .button-group button.secondary {
            background: #f0f0f0;
            color: #2c3e50;
        }
        
        .heatmap-controls {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .heatmap-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 22px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #3498db;
        }
        
        input:checked + .slider:before {
            transform: translateX(18px);
        }
        
        #log {
            padding: 12px;
            background: #f8fafc;
            border-top: 1px solid #e0e6ed;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .log-entry {
            margin-bottom: 6px;
            line-height: 1.4;
        }
        
        .log-time {
            color: #3498db;
            font-weight: 600;
        }
        
        #server-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: #f8fafc;
            border-top: 1px solid #e0e6ed;
            font-size: 14px;
        }
        
        .server-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #e74c3c;
        }
        
        #password-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 8px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
        }
        
        .modal-content h2 {
            margin-bottom: 16px;
            color: #2c3e50;
        }
        
        .modal-content p {
            margin-bottom: 20px;
            color: #5a6b7e;
        }
        
        #password-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d9e2;
            border-radius: 4px;
            font-size: 16px;
            margin-bottom: 16px;
        }
        
        #submit-password {
            width: 100%;
            padding: 12px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
        }
        
        #submit-password:hover {
            background: #2980b9;
        }
        #submit-password:disabled {
            cursor: default !important;
            opacity: 0.6;
        }
    </style>
</head>
<body>
    <!-- Password Modal -->
    <div id="password-modal">
        <div class="modal-content">
            <h2>Authentication Required</h2>
            <p>Please enter your access token to continue:</p>
            <input type="password" id="password-input" placeholder="Enter your token">
            <button id="submit-password">Connect</button>
        </div>
    </div>

    <div id="header">
        <div class="logo">
            <div class="logo-icon"><i class="fas fa-map-marker-alt"></i></div>
            <h1>Live Call Map v1</h1>
        </div>
    </div>
    
    <div id="container">
        <div id="sidebar">
            <div class="sidebar-section">
                <h3>Filters</h3>
                <div class="filters">
                    <div class="filter-group">
                        <label for="time-filter">Time Range</label>
                        <select id="time-filter">
                            <option value="5">Last 5 minutes</option>
                            <option value="15" selected>Last 15 minutes</option>
                            <option value="30">Last 30 minutes</option>
                            <option value="60">Last hour</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="area-filter">Area</label>
                        <select id="area-filter">
                            <option value="all" selected>All Areas</option>
                            <option value="north">North Region</option>
                            <option value="south">South Region</option>
                            <option value="east">East Region</option>
                            <option value="west">West Region</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-section">
                <h3>Statistics</h3>
                <div class="stats">
                    <div class="stat-box">
                        <div class="stat-value" id="total-calls">0</div>
                        <div class="stat-label">Total Calls</div>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-section" style="flex: 1; display: flex; flex-direction: column; overflow-y: auto;">
                <h3>Recent Calls</h3>
                <div id="calls-list" style="flex: 1; overflow-y: auto;">
                    <!-- Call items will be added here dynamically -->
                </div>
            </div>
        </div>
        
        <div id="map-container">
            <div id="map"></div>
            
            <!-- Draggable, collapsible Map Controls panel -->
            <div id="controls">
                <div id="controls-header">
                    <span>Map Controls</span>
                    <button id="toggle-controls">↓</button>
                </div>
                <div id="controls-content">
                    <div class="control-group">
                        <h3>Map Controls</h3>
                        <div class="button-group">
                            <button id="clearAll"><i class="fas fa-trash"></i> Clear All</button>
                            <button id="clusterView" class="secondary"><i class="fas fa-object-group"></i> Cluster View</button>
                        </div>
                        
                        <div class="heatmap-controls">
                            <div class="heatmap-toggle">
                                <span>Heatmap:</span>
                                <label class="switch">
                                    <input type="checkbox" id="heatmap-toggle">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            
                            <div class="filter-group">
                                <label for="ttl">Points TTL (sec):</label>
                                <input type="number" id="ttl" value="300" min="5" max="300">
                            </div>
                        </div>
                    </div>
                </div>
                <div id="log" style="display:none;"></div>
                <div id="server-status">
                    <div class="server-dot" id="server-status-dot"></div>
                    <span id="server-status-text">Not connected</span>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
    <script src="https://cdn.ably.io/lib/ably.min-1.js"></script>
    <script>
        // === CONFIG ===
        const ABLY_KEY = ''; // Your Ably key goes here
        const CHANNEL_NAME = 'getting-started-widget'; // channel to subscribe to
        // ==============

        // Initialize the map centered on Birmingham (ignore Scotland)
        const map = L.map('map').setView([52.48, -1.90], 7);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Initialize marker cluster group
        const clusterGroup = L.markerClusterGroup({ maxClusterRadius: 30 });
        map.addLayer(clusterGroup);

        // Initialize heat layer
        const heatLayer = L.heatLayer([], { radius: 25, blur: 15, maxZoom: 17 });
        
        // Store active pings
        const activePings = new Map();
        let callCounter = 0;
        const availableQueues = ["COPS - General", "COPS - Technical", "COPS - Billing"];

        // DOM elements
        const logElement = document.getElementById('log');
        const ttlInput = document.getElementById('ttl');
        const clearAllButton = document.getElementById('clearAll');
        const heatmapToggle = document.getElementById('heatmap-toggle');
        const serverStatusDot = document.getElementById('server-status-dot');
        const serverStatusText = document.getElementById('server-status-text');
        const callsList = document.getElementById('calls-list');
        const totalCallsElement = document.getElementById('total-calls');
        const activeCallsElement = document.getElementById('active-calls');
        
        function updateStats() {
            totalCallsElement.textContent = callCounter;
            activeCallsElement.textContent = activePings.size;
        }
        
        function addLogEntry(message) {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `<span class="log-time">${timeString}</span> - ${message}`;
            logElement.prepend(logEntry);
            if (logElement.children.length > 10) {
                logElement.removeChild(logElement.lastChild);
            }
        }
        
        function updateServerStatus(connected) {
            if (connected) {
                serverStatusDot.style.background = '#2ecc71';
                serverStatusText.textContent = 'Connected to 8x8 API';
            } else {
                serverStatusDot.style.background = '#e74c3c';
                serverStatusText.textContent = 'Not connected';
            }
        }
        
        function addCallToList(id, number, location, queue) {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            const callItem = document.createElement('div');
            callItem.className = 'call-item';
            callItem.id = `call-${id}`;
            callItem.innerHTML = `
                <div class="call-info">
                    <div class="call-number">${number}</div>
                    <div class="call-time">${timeString}</div>
                    <div class="call-location">${location}</div>
                    <div class="call-queue"><strong>Queue:</strong> ${queue}</div>
                </div>
                <div class="call-actions">
                    <button onclick="focusCall('${id}')">View</button>
                </div>
            `;
            callsList.prepend(callItem);
            if (callsList.children.length > 20) {
                callsList.removeChild(callsList.lastChild);
            }
        }
        
        function focusCall(id) {
            if (activePings.has(id)) {
                const ping = activePings.get(id);
                map.setView(ping.marker.getLatLng(), 15);
                ping.marker.openPopup();
            }
        }
        
        function showPing(id, lat, lng, number, location, ttl = 300000) {
            if (activePings.has(id)) {
                const ping = activePings.get(id);
                ping.marker.setLatLng([lat, lng]);
                ping.lastUpdate = Date.now();
                clearTimeout(ping.timeoutId);
                ping.timeoutId = setTimeout(() => removePing(id), ttl);
                addLogEntry(`Updated ping ${id} at ${lat.toFixed(4)}, ${lng.toFixed(4)}`);
                return ping.marker;
            }
            const queue = availableQueues[Math.floor(Math.random() * availableQueues.length)];
            const marker = L.marker([lat, lng], { icon: getIconForQueue(queue) });
            marker.bindPopup(`
                <div style="padding: 8px;">
                    <strong>Call from:</strong> ${number}<br>
                    <strong>Queue:</strong> ${queue}<br>
                    <strong>Location:</strong> ${location}<br>
                    <strong>Coordinates:</strong> ${lat.toFixed(6)}, ${lng.toFixed(6)}<br>
                    <strong>Received:</strong> ${new Date().toLocaleTimeString()}
                </div>
            `);
            clusterGroup.addLayer(marker);
            const timeoutId = setTimeout(() => removePing(id), ttl);
            activePings.set(id, { marker, timeoutId, lastUpdate: Date.now(), number, location, queue });
            updateHeatmap();
            addCallToList(id, number, location, queue);
            callCounter++;
            updateStats();
            addLogEntry(`New call from ${number} at ${location} via ${queue}`);
            return marker;
        }
        
        function removePing(id) {
            if (activePings.has(id)) {
                const ping = activePings.get(id);
                clearTimeout(ping.timeoutId);
                clusterGroup.removeLayer(ping.marker);
                activePings.delete(id);
                const callElement = document.getElementById(`call-${id}`);
                if (callElement) {
                    callElement.style.opacity = '0.5';
                    callElement.style.textDecoration = 'line-through';
                }
                updateHeatmap();
                updateStats();
                addLogEntry(`Removed ping ${id}`);
                return true;
            }
            return false;
        }
        
        function clearAllPings() {
            for (const [id, ping] of activePings.entries()) {
                clearTimeout(ping.timeoutId);
                clusterGroup.removeLayer(ping.marker);
                const callElement = document.getElementById(`call-${id}`);
                if (callElement) {
                    callsList.removeChild(callElement);
                }
            }
            activePings.clear();
            heatLayer.setLatLngs([]);
            updateStats();
            addLogEntry('Cleared all pings');
        }
        
        function updateHeatmap() {
            const points = [];
            for (const ping of activePings.values()) {
                const latlng = ping.marker.getLatLng();
                points.push([latlng.lat, latlng.lng, 0.5]);
            }
            heatLayer.setLatLngs(points);
        }
        
        function toggleHeatmap() {
            if (map.hasLayer(heatLayer)) {
                map.removeLayer(heatLayer);
                addLogEntry('Heatmap disabled');
            } else {
                map.addLayer(heatLayer);
                addLogEntry('Heatmap enabled');
            }
        }
        
        clearAllButton.addEventListener('click', clearAllPings);
        heatmapToggle.addEventListener('change', toggleHeatmap);
        window.focusCall = focusCall;

        // Define custom icons for different queues
        const blueIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
            shadowUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });
        const redIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
            shadowUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });
        const greenIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
            shadowUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });
        const greyIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-grey.png',
            shadowUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });
        function getIconForQueue(queue) {
            if (queue === 'COPS - General') return blueIcon;
            else if (queue === 'COPS - Technical') return redIcon;
            else if (queue === 'COPS - Billing') return greenIcon;
            return greyIcon;
        }

        // Make the controls panel draggable
        (function makeDraggable(){
            const controls = document.getElementById('controls');
            const header = document.getElementById('controls-header');
            let isDragging = false, offsetX = 0, offsetY = 0;
            header.addEventListener('mousedown', (e) => {
                isDragging = true;
                offsetX = e.clientX - controls.offsetLeft;
                offsetY = e.clientY - controls.offsetTop;
                controls.style.transition = 'none';
            });
            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    controls.style.left = (e.clientX - offsetX) + 'px';
                    controls.style.top = (e.clientY - offsetY) + 'px';
                }
            });
            document.addEventListener('mouseup', () => {
                isDragging = false;
                controls.style.transition = '';
            });
        })();

        // Collapsible behavior
        (function(){
            const toggleBtn = document.getElementById('toggle-controls');
            const content = document.getElementById('controls-content');
            toggleBtn.addEventListener('click', () => {
                if (content.style.display === 'none') {
                    content.style.display = 'block';
                    toggleBtn.textContent = '↑';
                } else {
                    content.style.display = 'none';
                    toggleBtn.textContent = '↓';
                }
            });
            // Start with controls collapsed
            content.style.display = 'none';
            toggleBtn.textContent = '↓';
        })();

        // Password authentication and Ably connection
        const passwordModal = document.getElementById('password-modal');
        const passwordInput = document.getElementById('password-input');
        const submitPassword = document.getElementById('submit-password');

        // Function to post token to Google Apps Script
        async function postPlain(token) {
            const url = 'https://script.google.com/macros/s/AKfycbzGDmH_NbsXPgvHSBEkppkUdJ9n4jk7Ha_rdK7GQNJIIwtRc2R7YGZ01TFlwSrcCaYExQ/exec';
            try {
                const resp = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain;charset=UTF-8'
                    },
                    body: 'token=' + encodeURIComponent(token)
                });
                const text = await resp.text();
                // console.log('response:', text);
                return text;
            } catch (error) {
                console.error('Error posting token:', error);
                throw error;
            }
        }

        // Handle password submission
        submitPassword.addEventListener('click', async () => {
            // Disable the Connect button immediately so it can only be pressed once
            submitPassword.disabled = true;
            
            const token = passwordInput.value.trim();
            if (!token) {
                alert('Please enter a token');
                // Re-enable the button if no token was provided
                submitPassword.disabled = false;
                return;
            }

            try {
                const result = await postPlain(token);
                passwordModal.style.display = 'none';
                addLogEntry('Authentication successful');
                connect(result); // Connect to Ably
            } catch (error) {
                alert('Authentication failed. Please check your token and try again.');
                console.error('Authentication error:', error);
                // Re-enable the button on failure
                submitPassword.disabled = false;
            }
        });

        // Allow submitting with Enter key
        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                submitPassword.click();
            }
        });

        // Connect to Ably
        function connect(albykey) {
            try {
                const ably = new Ably.Realtime({ key: albykey });
                const channel = ably.channels.get(CHANNEL_NAME);

                channel.subscribe((message) => {
                    console.log(message);
                    // Parse message data if it's a string
                    if (typeof message.data === 'string') {
                        try { 
                            message.data = JSON.parse(message.data);
                        } catch(e) { /* leave as string if invalid JSON */ }
                    }

                    // Now assume message.data is an object with:
                    // { number, queue, location, long, lat, time, status }
                    if (typeof message.data === 'object') {
                        showCallFromMessage(message.data);
                    }

                    addMessageToPanel(message);

                    // Compose notification title/body
                    const title = message.name ? `Alby message: ${message.name}` : 'Alby message';
                    let body;
                    try {
                        body = typeof message.data === 'string' ? message.data : JSON.stringify(message.data);
                    } catch(e) {
                        body = String(message.data);
                    }
                });

                ably.connection.on((stateChange) => {
                    console.log('Ably connection:', stateChange.current);
                    // Update connection status based on Ably connection state
                    if(stateChange.current === 'connected'){
                        updateServerStatus(true);
                    } else {
                        updateServerStatus(false);
                    }
                });

            } catch (err) {
                console.error('Ably connect failed', err);
                alert('Realtime connection failed: ' + err.message);
            }
        }

        // New function to add a marker from an Alby message with auto-removal via TTL.
        function showCallFromMessage(data) {
            console.log('New call data:', data);
            // Create a unique id for the call
            const id = 'call-' + Date.now();
            // Extract properties from the message data object:
            // Expected: number, queue, location, long, lat, time, status
            let { number, queue, location, long, lat, time, status } = data;
            
            // Normalize phone number (e.g. replace leading 44 with 0)
            const normalizedNumber = String(number).replace(/^44/, '0');

            // Remove any existing point with the same phone number
            activePings.forEach((ping, key) => {
                const existingNormalized = String(ping.number).replace(/^44/, '0');
                if (existingNormalized === normalizedNumber) {
                    removePing(key);
                }
            });

            // Convert lat/long to numbers if they are strings
            lat = Number(lat);
            long = Number(long);

            // Create marker at the provided lat/lng using an icon based on the queue
            const marker = L.marker([lat, long], { icon: getIconForQueue(queue) });
            marker.bindPopup(`
                <div style="padding: 8px;">
                    <strong>Call from:</strong> ${number}<br>
                    <strong>Queue:</strong> ${queue}<br>
                    <strong>Location:</strong> ${location}<br>
                    <strong>Coordinates:</strong> ${lat.toFixed(6)}, ${long.toFixed(6)}<br>
                    <strong>Time:</strong> ${time}<br>
                    <strong>Status:</strong> ${status}
                </div>
            `);

            clusterGroup.addLayer(marker);

            // Determine TTL from the input (in seconds) and convert to ms
            const ttlMs = parseInt(document.getElementById('ttl').value, 10) * 1000;
            const timeoutId = setTimeout(() => removePing(id), ttlMs);

            activePings.set(id, {
                marker: marker,
                timeoutId: timeoutId,
                lastUpdate: Date.now(),
                number: number,
                location: location,
                queue: queue
            });

            // Add to heatmap
            updateHeatmap();

            // Add to sidebar (using the existing function and passing the provided queue)
            addCallToList(id, number, location, queue);

            // Update counters and log
            callCounter++;
            updateStats();
            addLogEntry(`New call from ${number} at ${location} via ${queue}`);
        }

        // create UI container if not present
        function ensureUI() {
            if (document.getElementById('alby-messages-panel')) return;
            const panel = document.createElement('div');
            panel.id = 'alby-messages-panel';
            panel.style = `
                position: fixed; right: 12px; bottom: 12px;
                width: 320px; max-height: 50vh; overflow:auto;
                font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
                background: rgba(255,255,255,0.96); border: 1px solid rgba(0,0,0,0.08);
                box-shadow: 0 6px 24px rgba(0,0,0,0.12); border-radius: 8px; padding: 8px; z-index:99999;
            `;
            panel.innerHTML = `<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
                <strong style="font-size:14px">Live Alby messages</strong>
                <button id="alby-close-btn" title="Hide" style="background:none;border:0;font-size:16px;cursor:pointer">✕</button>
            </div><div id="alby-messages" style="gap:6px;display:flex;flex-direction:column"></div>`;
            document.body.appendChild(panel);
            panel.style.display = 'none'; // start hidden
            document.getElementById('alby-close-btn').onclick = () => panel.remove();
        }

        // simple toast (in-page)
        function showToast(text, ttl=6000){
            try {
                const t = document.createElement('div');
                t.textContent = text;
                t.style = 'position:fixed;right:12px;bottom:84px;padding:10px;border-radius:6px;background:#222;color:#fff;font-size:13px;z-index:999999;box-shadow:0 6px 20px rgba(0,0,0,0.25)';
                document.body.appendChild(t);
                setTimeout(()=> { t.style.transition='opacity 0.3s'; t.style.opacity = '0'; setTimeout(()=>t.remove(),300); }, ttl);
            } catch(e){ /* noop */ }
        }

        // add message to panel
        function addMessageToPanel(msg) {
            ensureUI();
            const list = document.getElementById('alby-messages');
            const item = document.createElement('div');
            item.style = 'padding:8px;border-radius:6px;background:linear-gradient(180deg,rgba(245,245,245,1),rgba(250,250,250,1));border:1px solid rgba(0,0,0,0.04);font-size:13px';
            const name = msg.name ? `[${msg.name}] ` : '';
            let dataText;
            try {
                dataText = typeof msg.data === 'string' ? msg.data : JSON.stringify(msg.data);
            } catch(e) {
                dataText = String(msg.data);
            }
            const time = new Date().toLocaleTimeString();
            item.innerHTML = `<div style="font-weight:600;margin-bottom:6px">${name}<span style="color:#666;font-weight:400;font-size:12px">${time}</span></div>
                            <div style="white-space:pre-wrap;word-break:break-word">${escapeHtml(dataText)}</div>`;
            list.prepend(item);
        }

        function escapeHtml(s){
            return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', () => {
            addLogEntry('System initialized');
            ensureUI();
            // The password modal is already visible
        });
    </script>
</body>
</html>